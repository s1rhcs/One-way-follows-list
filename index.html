<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fallen Follow Registry</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
    }

    :root {
      --radius-lg: 22px;
      --radius-pill: 999px;
      --transition-fast: 0.14s ease;
      --orb-x: 0px;
      --orb-y: 0px;
    }

    /* PURPLE THEME TOKENS */
    body.theme-dark {
      --ds-bg: #060112;
      --ds-panel-bg-main: #09041a;
      --ds-panel-bg-alt: #05000f;
      --ds-panel-border: #25114a;

      --ds-holo-blue: #9d00ff;
      --ds-holo-blue-soft: #e5b3ff;
      --ds-holo-orange: #ff6b9f;
      --ds-danger: #f97373;

      --ds-text-main: #fdf4ff;
      --ds-text-soft: #c4a7e7;

      --ds-grid-line: rgba(148, 119, 201, 0.2);
      --ds-row-even: #0b031d;
      --ds-row-odd: #050012;
      --ds-row-hover: #151030;
    }

    body.theme-light {
      --ds-bg: #faf5ff;
      --ds-panel-bg-main: #ffffff;
      --ds-panel-bg-alt: #ffffff;
      --ds-panel-border: #e9d5ff;

      --ds-holo-blue: #7c3aed;
      --ds-holo-blue-soft: #5b21b6;
      --ds-holo-orange: #ec4899;
      --ds-danger: #dc2626;

      --ds-text-main: #111827;
      --ds-text-soft: #6b21a8;

      --ds-grid-line: rgba(167, 139, 250, 0.26);
      --ds-row-even: #f5f3ff;
      --ds-row-odd: #ffffff;
      --ds-row-hover: #ede9fe;
    }

    body {
      font-family: "Nunito", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: var(--ds-text-main);
      background-color: var(--ds-bg);
      position: relative;
      overflow-x: hidden;
      transition: background-color 0.25s ease, color 0.25s ease;
      line-height: 1.7;
    }

    /* Subtle background grid */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        linear-gradient(var(--ds-grid-line) 1px, transparent 1px),
        linear-gradient(90deg, var(--ds-grid-line) 1px, transparent 1px);
      background-size: 80px 80px;
      opacity: 0.14;
      mix-blend-mode: soft-light;
      z-index: 0;
    }

    /* Roaming, blurred, glowing, pulsing orb */
    #status-orb {
      position: fixed;
      z-index: 0;
      pointer-events: none;
      width: 780px;
      height: 780px;
      border-radius: 50%;
      filter: blur(90px);
      opacity: 0.78;
      transition:
        background 0.6s ease-out,
        box-shadow 0.6s ease-out;
      box-shadow:
        0 0 140px rgba(255, 255, 255, 0.22),
        0 0 320px rgba(76, 29, 149, 0.65);
      transform: scale(1) translate3d(var(--orb-x), var(--orb-y), 0);
      animation: orbPulse 7s ease-in-out infinite;
    }

    body.theme-light #status-orb {
      opacity: 0.6;
      box-shadow:
        0 0 130px rgba(255, 255, 255, 0.55),
        0 0 260px rgba(167, 139, 250, 0.7);
    }

    @keyframes orbPulse {
      0%, 100% {
        transform: scale(1) translate3d(var(--orb-x), var(--orb-y), 0);
      }
      50% {
        transform: scale(1.06) translate3d(var(--orb-x), var(--orb-y), 0);
      }
    }

    .theme-toggle-bubble-global {
      position: fixed;
      top: 14px;
      right: 14px;
      z-index: 50;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #050015;
      border: 1px solid #25114a;
      box-shadow:
        0 6px 14px rgba(0, 0, 0, 1),
        0 0 16px rgba(76, 29, 149, 0.9);
      font-size: 11px;
      color: var(--ds-text-soft);
      white-space: nowrap;
    }

    body.theme-light .theme-toggle-bubble-global {
      background: #ede9fe;
      border-color: #ddd6fe;
      box-shadow:
        0 6px 16px rgba(148, 163, 184, 0.5),
        0 0 14px rgba(167, 139, 250, 0.6);
      color: #1f2937;
    }

    .theme-toggle-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-weight: 600;
    }

    .theme-toggle-btn {
      border-radius: var(--radius-pill);
      border: 1px solid #1e1b4b;
      background: radial-gradient(circle at top, #312e81, #020617);
      color: #e5e7eb;
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 1),
        0 0 14px rgba(76, 29, 149, 0.9);
      transition:
        transform 0.1s ease,
        box-shadow 0.15s ease,
        background 0.15s ease,
        color 0.15s ease;
    }

    .theme-toggle-btn span.icon { font-size: 13px; }

    body.theme-light .theme-toggle-btn {
      background: radial-gradient(circle at top, #f5f3ff, #c4b5fd);
      color: #111827;
      border-color: #a855f7;
      box-shadow:
        0 4px 10px rgba(167, 139, 250, 0.6),
        0 0 12px rgba(167, 139, 250, 0.7);
    }

    .theme-toggle-btn:hover {
      transform: translateY(-1px);
      box-shadow:
        0 6px 14px rgba(0, 0, 0, 1),
        0 0 18px rgba(76, 29, 149, 0.9);
    }

    body.theme-light .theme-toggle-btn:hover {
      box-shadow:
        0 6px 16px rgba(167, 139, 250, 0.7),
        0 0 18px rgba(167, 139, 250, 0.7);
    }

    .landing {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 20px;
      position: relative;
      z-index: 1;
    }

    .landing-panel {
      max-width: 720px;
      width: 100%;
      padding: 28px 28px 22px;
      border-radius: 26px;
      background:
        radial-gradient(circle at top left, rgba(46, 16, 101, 0.98) 0, rgba(15, 23, 42, 0.98) 60%),
        linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(12, 10, 35, 0.98));
      border: 1px solid rgba(76, 29, 149, 0.95);
      box-shadow:
        0 24px 40px rgba(0, 0, 0, 1),
        0 0 40px rgba(76, 29, 149, 0.9);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      position: relative;
      overflow: hidden;
    }

    body.theme-light .landing-panel {
      background: #ffffff;
      border-color: var(--ds-panel-border);
      box-shadow:
        0 16px 30px rgba(148, 163, 184, 0.35),
        0 0 18px rgba(167, 139, 250, 0.25);
    }

    .landing-panel::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: 24px;
      border: 1px solid rgba(148, 119, 201, 0.7);
      box-shadow:
        0 0 24px rgba(129, 140, 248, 0.9),
        0 0 60px rgba(67, 56, 202, 0.8);
      opacity: 0.6;
      pointer-events: none;
    }

    body.theme-light .landing-panel::before {
      border-color: rgba(221, 214, 254, 0.9);
      box-shadow:
        0 0 20px rgba(167, 139, 250, 0.45),
        0 0 40px rgba(191, 219, 254, 0.3);
    }

    .landing-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 16px;
    }

    .landing-title-wrap { display: flex; flex-direction: column; gap: 4px; }

    .landing-title {
      font-size: 22px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      margin: 0;
      color: var(--ds-holo-blue-soft);
      text-shadow:
        0 0 4px rgba(192, 132, 252, 0.7),
        0 0 12px rgba(147, 51, 234, 0.9);
    }

    body.theme-light .landing-title { text-shadow: none; }

    .landing-sub {
      font-size: 15px;
      color: var(--ds-text-soft);
      margin: 0;
      letter-spacing: 0.01em;
    }

    .landing-chip {
      font-size: 11px;
      padding: 6px 14px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(192, 132, 252, 0.8);
      background:
        linear-gradient(135deg, #1e0933, #0b0418);
      color: var(--ds-holo-blue-soft);
      white-space: normal;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow:
        0 0 8px rgba(192, 132, 252, 0.9),
        0 0 22px rgba(76, 29, 149, 0.9);
      max-width: 260px;
      text-align: right;
    }

    body.theme-light .landing-chip {
      background: linear-gradient(135deg, #ede9fe, #e0e7ff);
      border-color: #c4b5fd;
      color: #5b21b6;
      box-shadow:
        0 0 8px rgba(221, 214, 254, 0.9),
        0 0 18px rgba(199, 210, 254, 0.7);
    }

    .step-list {
      margin: 10px 0 18px;
      padding-left: 22px;
      font-size: 14px;
      color: var(--ds-text-soft);
    }

    .step-list li { margin-bottom: 6px; }

    .upload-box {
      margin-top: 6px;
      padding: 16px 16px 14px;
      border-radius: 20px;
      background: linear-gradient(135deg, #09041a, #05000f);
      border: 1px solid #312e81;
      box-shadow:
        0 12px 30px rgba(0, 0, 0, 0.95),
        inset 0 0 0 1px rgba(55, 48, 163, 0.9);
    }

    body.theme-light .upload-box {
      background: #f5f3ff;
      border-color: #ddd6fe;
      box-shadow:
        0 10px 24px rgba(148, 163, 184, 0.5),
        inset 0 0 0 1px rgba(221, 214, 254, 0.8);
    }

    .upload-label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .upload-title {
      font-size: 15px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .upload-hint {
      font-size: 12px;
      color: var(--ds-text-soft);
    }

    #file-input {
      display: block;
      margin: 0 auto 8px;
      color: transparent;
      max-width: 100%;
    }

    #file-input::file-selector-button {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(192, 132, 252, 0.8);
      background: linear-gradient(135deg, #1b1033, #0b041a);
      color: var(--ds-holo-blue-soft);
      font-size: 13px;
      font-weight: 700;
      padding: 9px 24px;
      cursor: pointer;
      margin-right: 10px;
      box-shadow:
        0 0 0 1px rgba(24, 16, 52, 0.9),
        0 0 24px rgba(192, 132, 252, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.16em;
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        filter var(--transition-fast),
        border-color var(--transition-fast);
    }

    body.theme-light #file-input::file-selector-button {
      background: linear-gradient(135deg, #ede9fe, #e0e7ff);
      color: #5b21b6;
      box-shadow:
        0 0 0 1px rgba(221, 214, 254, 0.9),
        0 0 20px rgba(221, 214, 254, 0.9);
      border-color: #c4b5fd;
    }

    #file-input::file-selector-button:hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow:
        0 0 0 1px rgba(24, 16, 52, 1),
        0 0 30px rgba(192, 132, 252, 0.95);
      filter: brightness(1.06);
      border-color: var(--ds-holo-blue-soft);
    }

    body.theme-light #file-input::file-selector-button:hover {
      box-shadow:
        0 0 0 1px rgba(221, 214, 254, 1),
        0 0 26px rgba(221, 214, 254, 1);
      filter: brightness(1.03);
    }

    #file-input::file-selector-button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow:
        0 0 0 1px rgba(24, 16, 52, 0.9),
        0 0 18px rgba(192, 132, 252, 0.8);
      filter: brightness(0.97);
    }

    body.theme-light #file-input::file-selector-button:active {
      box-shadow:
        0 0 0 1px rgba(221, 214, 254, 0.9),
        0 0 18px rgba(221, 214, 254, 0.9);
    }

    .file-pills {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }

    .file-pill {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 7px 12px;
      border-radius: var(--radius-pill);
      background: #0b0418;
      font-size: 13px;
      box-shadow:
        inset 0 0 0 1px #312e81,
        0 3px 10px rgba(0, 0, 0, 0.85);
    }

    body.theme-light .file-pill {
      background: #f5f3ff;
      box-shadow:
        inset 0 0 0 1px #ddd6fe,
        0 2px 8px rgba(148, 163, 184, 0.5);
    }

    .file-pill-left { display: flex; align-items: center; gap: 8px; }

    .file-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #4b5563;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
    }

    .file-label {
      color: var(--ds-text-main);
      font-weight: 500;
    }

    .file-name {
      color: var(--ds-text-soft);
      font-size: 12px;
    }

    .file-pill.ready .file-dot {
      background: var(--ds-holo-blue);
      box-shadow: 0 0 10px rgba(192, 132, 252, 0.95);
    }

    body.theme-light .file-pill.ready .file-dot {
      box-shadow: 0 0 10px rgba(167, 139, 250, 0.7);
    }

    .file-pill.ready .file-name {
      color: var(--ds-holo-blue-soft);
      font-weight: 500;
    }

    .file-pill.error .file-dot {
      background: var(--ds-danger);
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.95);
    }

    .file-pill.error .file-name {
      color: #fecaca;
      font-weight: 500;
    }

    .file-status-text {
      font-size: 12px;
      color: var(--ds-text-soft);
      margin-top: 7px;
      min-height: 16px;
    }

    .file-status-text.ok { color: var(--ds-holo-blue-soft); }
    .file-status-text.err { color: #fecaca; }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
    }

    .build-btn {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(236, 72, 153, 0.8);
      background:
        linear-gradient(135deg, #3b0b2f, #4a0433),
        radial-gradient(circle at top, rgba(244, 114, 182, 0.45) 0, transparent 60%);
      color: #fff1f2;
      font-size: 13px;
      padding: 9px 24px;
      cursor: pointer;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 1),
        0 8px 20px rgba(0, 0, 0, 1),
        0 0 18px rgba(244, 114, 182, 0.9),
        0 0 36px rgba(244, 114, 182, 0.7);
      transition:
        transform var(--transition-fast),
        box-shadow var(--transition-fast),
        opacity var(--transition-fast),
        filter var(--transition-fast),
        border-color var(--transition-fast);
    }

    body.theme-light .build-btn {
      background:
        linear-gradient(135deg, #ec4899, #db2777),
        radial-gradient(circle at top, rgba(244, 114, 182, 0.5) 0, transparent 60%);
      color: #111827;
      box-shadow:
        0 3px 10px rgba(244, 114, 182, 0.5),
        0 8px 20px rgba(244, 114, 182, 0.4);
      border-color: #f9a8d4;
    }

    .build-btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
      filter: grayscale(0.35);
    }

    .build-btn:not(:disabled):hover {
      transform: translateY(-1px) scale(1.01);
      box-shadow:
        0 3px 8px rgba(0, 0, 0, 1),
        0 12px 26px rgba(0, 0, 0, 1),
        0 0 26px rgba(244, 114, 182, 1),
        0 0 48px rgba(244, 114, 182, 0.85);
      filter: brightness(1.05);
      border-color: #f9a8d4;
    }

    body.theme-light .build-btn:not(:disabled):hover {
      box-shadow:
        0 4px 10px rgba(244, 114, 182, 0.6),
        0 12px 24px rgba(244, 114, 182, 0.5);
    }

    .build-btn:not(:disabled):active {
      transform: translateY(1px) scale(0.99);
      box-shadow:
        0 2px 6px rgba(0, 0, 0, 1),
        0 8px 20px rgba(0, 0, 0, 0.95),
        0 0 18px rgba(251, 182, 206, 0.9);
      filter: brightness(0.98);
    }

    .upload-status {
      font-size: 12px;
      text-align: right;
      color: var(--ds-holo-blue-soft);
    }

    .upload-status.loading { color: var(--ds-holo-orange); }
    .upload-status.done { color: var(--ds-holo-blue); }
    .upload-status.error { color: var(--ds-danger); }

    .tutorial-card {
      margin-top: 14px;
      padding: 10px 13px;
      border-radius: 18px;
      background: #09041a;
      border: 1px solid #312e81;
      font-size: 12px;
      color: var(--ds-text-main);
      line-height: 1.6;
      box-shadow:
        0 10px 24px rgba(0, 0, 0, 0.95),
        inset 0 0 0 1px rgba(55, 48, 163, 0.9);
    }

    body.theme-light .tutorial-card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow:
        0 8px 20px rgba(148, 163, 184, 0.4),
        inset 0 0 0 1px rgba(229, 231, 235, 0.9);
    }

    .tutorial-card details { cursor: pointer; }

    .tutorial-card summary {
      list-style: none;
      font-weight: 600;
      color: var(--ds-holo-blue-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tutorial-card summary::before {
      content: "‚ñ∏";
      font-size: 11px;
      transition: transform 0.15s ease;
      color: var(--ds-holo-orange);
    }

    .tutorial-card details[open] summary::before {
      transform: rotate(90deg);
    }

    .tutorial-card summary::-webkit-details-marker { display: none; }
    .tutorial-card details[open] summary { margin-bottom: 6px; }

    .tutorial-card ol { margin: 0; padding-left: 20px; }

    .landing-footer {
      margin-top: 14px;
      font-size: 12px;
      color: var(--ds-text-soft);
      line-height: 1.6;
    }

    .landing-footer strong { color: var(--ds-holo-blue-soft); }

    /* Narrower page so orb shows around main app on desktop/tablet */
    .page {
      max-width: 1040px;
      width: 100%;
      margin: 0 auto;
      padding: 40px 32px 48px;
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .hidden { display: none !important; }

    .header-card,
    .table-card {
      background: linear-gradient(145deg, var(--ds-panel-bg-main), var(--ds-panel-bg-alt));
      border-radius: 28px;
      border: 1px solid var(--ds-panel-border);
      box-shadow:
        0 26px 70px rgba(0, 0, 0, 1),
        0 0 36px rgba(76, 29, 149, 0.9);
      position: relative;
      overflow: hidden;
    }

    body.theme-light .header-card,
    body.theme-light .table-card {
      background: #ffffff;
      box-shadow:
        0 18px 40px rgba(148, 163, 184, 0.45),
        0 0 18px rgba(167, 139, 250, 0.25);
    }

    .header-card {
      padding: 22px 26px 18px;
      margin-bottom: 18px;
      line-height: 1.6;
    }

    /* table-card scrollable on small screens */
    .table-card {
      margin-top: 8px;
      overflow-x: auto;
    }

    /* extra breathing room for orb at mid breakpoints */
    @media (max-width: 1200px) {
      .header-card,
      .table-card {
        margin-inline: 32px;
      }
    }

    @media (max-width: 900px) {
      .page {
        padding: 24px 16px 32px;
      }
      .header-card,
      .table-card {
        margin-inline: 16px;
      }
    }

    .header-top-row {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .title-row {
      display: inline-flex;
      align-items: center;
      gap: 14px;
      padding: 10px 32px;
      border-radius: 999px;
      background: #0b0418;
      border: 1px solid rgba(192, 132, 252, 0.9);
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 1),
        0 16px 32px rgba(0, 0, 0, 1),
        0 0 22px rgba(192, 132, 252, 0.9);
    }

    body.theme-light .title-row {
      background: #ede9fe;
      border-color: #c4b5fd;
      box-shadow:
        0 6px 18px rgba(148, 163, 184, 0.7),
        0 0 20px rgba(199, 210, 254, 0.8);
    }

    .title-emoji { font-size: 26px; }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--ds-holo-blue-soft);
      text-shadow:
        0 0 6px rgba(192, 132, 252, 0.7),
        0 0 14px rgba(147, 51, 234, 0.9);
    }

    body.theme-light h1 { text-shadow: none; }

    .subtitle {
      margin: 0 0 4px;
      font-size: 13px;
      color: var(--ds-text-soft);
      line-height: 1.7;
      letter-spacing: 0.01em;
    }

    #joke-line {
      margin-top: 4px;
      font-size: 12px;
      color: var(--ds-holo-orange);
      opacity: 0.9;
    }

    .controls {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
    }

    .search-box input {
      background: #0b0418;
      border-radius: var(--radius-pill);
      border: 1px solid #312e81;
      padding: 6px 12px;
      color: var(--ds-text-main);
      font-size: 13px;
      min-width: 220px;
      outline: none;
      transition:
        border-color var(--transition-fast),
        box-shadow var(--transition-fast),
        transform 0.1s ease;
    }

    body.theme-light .search-box input {
      background: #f5f3ff;
      border-color: #ddd6fe;
    }

    .search-box input::placeholder { color: #6b7280; }

    .search-box input:focus {
      border-color: var(--ds-holo-blue);
      box-shadow: 0 0 0 1px rgba(192, 132, 252, 0.7);
      transform: translateY(-1px);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
      align-items: center;
      max-width: 780px;
    }

    .filter-chip {
      border-radius: var(--radius-pill);
      border: 1px solid #312e81;
      padding: 5px 10px;
      font-size: 11px;
      background: #0b0418;
      color: var(--ds-text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition:
        background var(--transition-fast),
        border-color var(--transition-fast),
        transform 0.1s ease,
        box-shadow var(--transition-fast),
        color var(--transition-fast);
    }

    body.theme-light .filter-chip {
      background: #f5f3ff;
      border-color: #ddd6fe;
      color: #6b21a8;
    }

    .filter-chip span.count {
      background: #020617;
      border-radius: 999px;
      padding: 1px 6px;
      font-size: 10px;
    }

    body.theme-light .filter-chip span.count {
      background: #e5e7eb;
    }

    .filter-chip.active {
      border-color: var(--ds-holo-blue);
      color: var(--ds-holo-blue-soft);
      background: #1b1033;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.95);
    }

    body.theme-light .filter-chip.active {
      background: #ede9fe;
      box-shadow: 0 4px 12px rgba(148, 163, 184, 0.6);
    }

    .filter-chip:hover { transform: translateY(-0.5px); }

    .filter-chip-primary { margin-left: 4px; }

    .filter-divider {
      display: inline-block;
      width: 18px;
      height: 1px;
    }

    .top-controls-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-top: 10px;
    }

    .legend-text {
      margin: 12px auto 0;
      padding: 8px 16px;
      border-radius: 18px;
      background: rgba(17, 24, 39, 0.94);
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
      color: var(--ds-text-soft);
      max-width: 720px;
      box-shadow:
        0 10px 26px rgba(0, 0, 0, 0.9),
        0 0 16px rgba(15, 23, 42, 0.8);
      letter-spacing: 0.01em;
    }

    .legend-text ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 14px;
      justify-content: center;
    }

    .legend-text li {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      box-shadow: 0 0 6px rgba(148, 163, 184, 0.8);
    }

    .legend-dot.unfollowed  { background: #f87171; }
    .legend-dot.influencer  { background: #60a5fa; }
    .legend-dot.news        { background: #facc15; }
    .legend-dot.meme        { background: #34d399; }
    .legend-dot.other       { background: #a855f7; }

    body.theme-light .legend-text {
      background: rgba(243, 244, 246, 0.98);
      border-color: rgba(209, 213, 219, 0.9);
      box-shadow:
        0 8px 20px rgba(148, 163, 184, 0.6),
        0 0 14px rgba(209, 213, 219, 0.7);
    }

    .reset-btn {
      border-radius: var(--radius-pill);
      border: 1px solid #312e81;
      background: #0b0418;
      color: var(--ds-text-soft);
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      transition:
        background var(--transition-fast),
        border-color var(--transition-fast),
        transform 0.1s ease,
        box-shadow var(--transition-fast),
        color var(--transition-fast);
    }

    body.theme-light .reset-btn {
      background: #f5f3ff;
      border-color: #ddd6fe;
      color: #6b21a8;
    }

    .reset-btn:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
    }

    body.theme-light .reset-btn:hover {
      box-shadow: 0 3px 8px rgba(148, 163, 184, 0.7);
    }

    .progress-bar-wrap {
      margin-top: 10px;
      width: 100%;
      max-width: 380px;
      height: 6px;
      border-radius: 999px;
      border: 1px solid #1e1b4b;
      margin-left: auto;
      margin-right: auto;
      overflow: hidden;
      background: #020617;
    }

    body.theme-light .progress-bar-wrap {
      border-color: #e5e7eb;
      background: #f3f4f6;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--ds-holo-orange), var(--ds-holo-blue));
      box-shadow: 0 0 12px rgba(192, 132, 252, 0.8);
      transition: width 0.25s ease-out;
    }

    #progress-text {
      margin-top: 4px;
      font-size: 11px;
      color: var(--ds-text-soft);
      text-align: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 640px;
    }

    thead { background: #0b0418; }
    body.theme-light thead { background: #f5f3ff; }

    th, td {
      padding: 9px 12px;
      font-size: 12.5px;
      text-align: left;
      white-space: nowrap;
      line-height: 1.7;
    }

    th {
      font-weight: 600;
      color: var(--ds-text-main);
      border-bottom: 1px solid #312e81;
      cursor: pointer;
    }

    body.theme-light th { border-bottom-color: #ddd6fe; }

    th.sortable::after {
      content: "‚áÖ";
      font-size: 10px;
      margin-left: 4px;
      opacity: 0.6;
    }

    th.sortable.asc::after { content: "‚Üë"; }
    th.sortable.desc::after { content: "‚Üì"; }

    tbody tr:nth-child(even) { background: var(--ds-row-even); }
    tbody tr:nth-child(odd)  { background: var(--ds-row-odd); }

    tbody tr:hover {
      outline: 1px solid rgba(148, 163, 184, 0.24);
      outline-offset: -1px;
    }

    td.user-cell { font-weight: 500; }
    td.date-cell { color: #9ca3af; font-size: 12px; }
    td.status-cell { width: 1%; }

    a {
      color: var(--ds-holo-blue-soft);
      text-decoration: none;
      font-weight: 500;
      transition: color var(--transition-fast), text-shadow var(--transition-fast);
    }

    a:hover {
      text-decoration: underline;
      text-shadow: 0 0 8px rgba(192, 132, 252, 0.7);
    }

    .user-main {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .user-copy-btn {
      border-radius: 999px;
      border: 1px solid #312e81;
      background: #020617;
      color: var(--ds-text-soft);
      font-size: 10px;
      padding: 2px 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition:
        background var(--transition-fast),
        border-color var(--transition-fast),
        transform 0.1s ease,
        box-shadow var(--transition-fast),
        color var(--transition-fast);
    }

    body.theme-light .user-copy-btn {
      background: #f3f4f6;
      border-color: #d1d5db;
      color: #374151;
    }

    .user-copy-btn:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.7);
    }

    body.theme-light .user-copy-btn:hover {
      box-shadow: 0 2px 6px rgba(148, 163, 184, 0.7);
    }

    .user-copy-btn.copied {
      background: #022c22;
      color: #6ee7b7;
      border-color: #22c55e;
    }

    body.theme-light .user-copy-btn.copied {
      background: #ecfdf3;
      color: #16a34a;
      border-color: #4ade80;
    }

    .tag-btn,
    .copy-btn {
      border-radius: var(--radius-pill);
      border: 1px solid #312e81;
      background: #0b0418;
      color: var(--ds-text-soft);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
      margin-right: 4px;
      transition:
        background var(--transition-fast),
        border-color var(--transition-fast),
        transform 0.1s ease,
        box-shadow var(--transition-fast),
        color var(--transition-fast);
    }

    body.theme-light .tag-btn,
    body.theme-light .copy-btn {
      background: #f5f3ff;
      border-color: #ddd6fe;
      color: #6b21a8;
    }

    .tag-btn:hover,
    .copy-btn:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.9);
    }

    body.theme-light .tag-btn:hover,
    body.theme-light .copy-btn:hover {
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.7);
    }

    .tag-btn.active[data-tag="unfollowed"] {
      background: #991b1b;
      color: #fee2e2;
      border-color: #fecaca;
      box-shadow:
        0 0 10px rgba(248, 113, 113, 0.9),
        0 0 22px rgba(185, 28, 28, 0.95);
      transform: translateY(-0.5px) scale(1.02);
    }

    .tag-btn.active[data-tag="influencer"] {
      background: #1d4ed8;
      color: #dbeafe;
      border-color: #bfdbfe;
      box-shadow:
        0 0 10px rgba(96, 165, 250, 0.9),
        0 0 22px rgba(30, 64, 175, 0.95);
      transform: translateY(-0.5px) scale(1.02);
    }

    .tag-btn.active[data-tag="news"] {
      background: #ca8a04;
      color: #fef9c3;
      border-color: #facc15;
      box-shadow:
        0 0 10px rgba(250, 204, 21, 0.95),
        0 0 22px rgba(202, 138, 4, 0.95);
      transform: translateY(-0.5px) scale(1.02);
    }

    .tag-btn.active[data-tag="meme"] {
      background: #15803d;
      color: #dcfce7;
      border-color: #bbf7d0;
      box-shadow:
        0 0 10px rgba(34, 197, 94, 0.95),
        0 0 22px rgba(21, 128, 61, 0.95);
      transform: translateY(-0.5px) scale(1.02);
    }

    .tag-btn.active[data-tag="other"] {
      background: #7e22ce;
      color: #f3e8ff;
      border-color: #e9d5ff;
      box-shadow:
        0 0 10px rgba(192, 132, 252, 0.95),
        0 0 22px rgba(126, 34, 206, 0.95);
      transform: translateY(-0.5px) scale(1.02);
    }

    .copy-btn.copied {
      background: #022c22;
      color: #6ee7b7;
      border-color: #22c55e;
    }

    body.theme-light .copy-btn.copied {
      background: #ecfdf3;
      color: #16a34a;
      border-color: #4ade80;
    }

    /* Hide orb completely on small screens as a safety net */
    @media (max-width: 700px) {
      #status-orb {
        display: none;
      }
    }

    @media (max-width: 700px) {
      .landing-header-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .landing-chip { align-self: flex-start; }
      h1,
      .landing-title { font-size: 18px; }
      th, td {
        font-size: 11.5px;
        padding: 7px 8px;
      }
      .header-top-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .top-controls-row {
        flex-direction: column;
        align-items: stretch;
      }
      .page {
        padding: 24px 14px 32px;
      }
      .title-row {
        padding: 8px 18px;
      }
      h1 {
        font-size: 18px;
        letter-spacing: 0.16em;
      }
      .legend-text {
        padding: 8px 10px;
      }
      .legend-text ul {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-card,
      .table-card {
        border-radius: 18px;
      }
      .filters {
        max-width: 100%;
      }
    }
  </style>
</head>
<body class="theme-dark">
  <div id="status-orb"></div>

  <div class="theme-toggle-bubble-global">
    <span class="theme-toggle-label">Theme</span>
    <button id="theme-toggle-btn" class="theme-toggle-btn">
      <span class="icon" id="theme-icon">üåô</span>
      <span id="theme-label-text">Dark</span>
    </button>
  </div>

  <div class="landing" id="landing">
    <div class="landing-panel">
      <div class="landing-header-row">
        <div class="landing-title-wrap">
          <h1 class="landing-title">FALLEN FOLLOW REGISTRY</h1>
          <p class="landing-sub">Logging every follow that didn‚Äôt follow through.</p>
        </div>
        <div class="landing-chip">
          Secure ‚Ä¢ No servers ‚Ä¢ No sign up ‚Ä¢ No BS ‚Ä¢ All private
        </div>
      </div>

      <ol class="step-list">
        <li>Export your Instagram data ZIP.</li>
        <li>Grab <strong>followers_1.json</strong> and <strong>following.json</strong>.</li>
        <li>Use the button below to select both files.</li>
      </ol>

      <div class="upload-box">
        <div class="upload-label-row">
          <span class="upload-title">Upload your JSON files</span>
          <span class="upload-hint">Only followers_1.json and following.json are needed.</span>
        </div>

        <input type="file" id="file-input" multiple accept=".json">

        <div class="file-pills">
          <div class="file-pill" id="pill-followers">
            <div class="file-pill-left">
              <span class="file-dot"></span>
              <span class="file-label">followers_1.json</span>
            </div>
            <span class="file-name" id="name-followers">(waiting)</span>
          </div>
          <div class="file-pill" id="pill-following">
            <div class="file-pill-left">
              <span class="file-dot"></span>
              <span class="file-label">following.json</span>
            </div>
            <span class="file-name" id="name-following">(waiting)</span>
          </div>
        </div>

        <div id="file-status-text" class="file-status-text">
          Choose both files to get started.
        </div>

        <div class="actions-row">
          <button id="build-btn" class="build-btn" disabled>Build Fallen Follows list</button>
          <div class="upload-status" id="upload-status"></div>
        </div>
      </div>

      <div class="tutorial-card">
        <details>
          <summary>How do I get these Instagram files?</summary>
          <ol>
            <li><strong>On phone or desktop:</strong> Open Instagram and go to <strong>Settings ‚Üí Accounts Center</strong>.</li>
            <li>Tap <strong>Your information and permissions ‚Üí Export your information</strong>.</li>
            <li>Select your Instagram account and choose <strong>Some of your information</strong>.</li>
            <li>Only check <strong>Followers and following</strong>, set format to <strong>JSON</strong>, and choose <strong>Download to device</strong>.</li>
            <li><strong>On desktop or laptop (recommended):</strong> Open the email or notification from Instagram, download the ZIP, and unzip it.</li>
            <li>In the unzipped folder, open <code>connections/followers_and_following</code>.</li>
            <li>Pick <strong>followers_1.json</strong> and <strong>following.json</strong> from that folder and upload them here.</li>
          </ol>
        </details>
      </div>

      <div class="landing-footer">
        Export from Instagram via <strong>Settings ‚Üí Accounts Center ‚Üí Export your information</strong>, then grab these two files from the ZIP.
      </div>
    </div>
  </div>

  <div class="page hidden" id="main-app">
    <div class="header-card" id="header-card">
      <div class="header-top-row">
        <div class="title-row">
          <span class="title-emoji">‚ö†Ô∏è</span>
          <h1>FALLEN FOLLOW REGISTRY</h1>
          <span class="title-emoji">‚ö†Ô∏è</span>
        </div>
      </div>

      <p class="subtitle">
        Logging every follow that didn‚Äôt follow through.
      </p>
      <p class="subtitle">
        People you follow who don‚Äôt follow you back: <span id="count-total">0</span>
      </p>
      <p class="subtitle" id="joke-line"></p>

      <div class="controls">
        <div class="search-box">
          <input type="text" id="search-input" placeholder="Search username..." />
        </div>
        <div class="filters">
          <button class="filter-chip" data-filter="all">
            Show all <span class="count" id="count-all">0</span>
          </button>

          <button class="filter-chip filter-chip-primary" data-filter="unfollowed">
            Unfollowed ‚ùå <span class="count" id="count-unfollowed">0</span>
          </button>

          <span class="filter-divider"></span>

          <button class="filter-chip" data-filter="influencer">
            Influencer / Celeb üé• <span class="count" id="count-influencer">0</span>
          </button>
          <button class="filter-chip" data-filter="news">
            News üì∞ <span class="count" id="count-news">0</span>
          </button>
          <button class="filter-chip" data-filter="meme">
            Meme Page üòÇ <span class="count" id="count-meme">0</span>
          </button>
          <button class="filter-chip" data-filter="other">
            Other üìÇ <span class="count" id="count-other">0</span>
          </button>
        </div>
      </div>

      <div class="top-controls-row">
        <div class="legend-text">
          <ul>
            <li><span class="legend-dot unfollowed"></span>Unfollowed = you removed them</li>
            <li><span class="legend-dot influencer"></span>Influencer/Celeb = big accounts</li>
            <li><span class="legend-dot news"></span>News = info feeds</li>
            <li><span class="legend-dot meme"></span>Meme Page = fun only</li>
            <li><span class="legend-dot other"></span>Other = everything else</li>
          </ul>
        </div>
        <button id="reset-tags-btn" class="reset-btn" type="button">Reset all tags</button>
      </div>

      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
      <p class="subtitle" id="progress-text"></p>
    </div>

    <div class="table-card" id="table-card">
      <table id="fake-list-table">
        <thead>
          <tr>
            <th class="sortable" data-sort-key="username">Username</th>
            <th class="sortable" data-sort-key="timestamp">Followed at</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const jokes = [
      "Purge time.",
      "Fuck them.",
      "It's more than just a follow. it's personal.",
      "If they wanted to they would."
    ];

    const TAG_STORAGE_KEY = "fallenfollow_tags_v2";
    const VALID_TAGS = ["unfollowed", "influencer", "news", "meme", "other"];

    const fileInput = document.getElementById("file-input");
    const buildBtn = document.getElementById("build-btn");
    const uploadStatus = document.getElementById("upload-status");
    const pillFollowers = document.getElementById("pill-followers");
    const pillFollowing = document.getElementById("pill-following");
    const nameFollowers = document.getElementById("name-followers");
    const nameFollowing = document.getElementById("name-following");
    const fileStatusText = document.getElementById("file-status-text");
    const landing = document.getElementById("landing");
    const mainApp = document.getElementById("main-app");

    const themeToggleBtn = document.getElementById("theme-toggle-btn");
    const themeIcon = document.getElementById("theme-icon");
    const themeLabelText = document.getElementById("theme-label-text");

    const orbEl = document.getElementById("status-orb");

    let followersJson = null;
    let followingJson = null;
    let tagMap = {};

    function setThemeUI(theme) {
      if (theme === "light") {
        themeIcon.textContent = "‚òÄÔ∏è";
        themeLabelText.textContent = "Light";
      } else {
        themeIcon.textContent = "üåô";
        themeLabelText.textContent = "Dark";
      }
    }

    function applyTheme(theme) {
      const body = document.body;
      if (theme === "light") {
        body.classList.remove("theme-dark");
        body.classList.add("theme-light");
      } else {
        body.classList.remove("theme-light");
        body.classList.add("theme-dark");
      }
      localStorage.setItem("fallenfollow_theme", theme);
      setThemeUI(theme);
    }

    (function initTheme() {
      const stored = localStorage.getItem("fallenfollow_theme");
      if (stored === "light" || stored === "dark") {
        applyTheme(stored);
      } else {
        applyTheme("dark");
      }
    })();

    function toggleTheme() {
      const current = document.body.classList.contains("theme-light") ? "light" : "dark";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
    }

    themeToggleBtn.addEventListener("click", toggleTheme);

    function loadTagMap() {
      try {
        const raw = localStorage.getItem(TAG_STORAGE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") return parsed;
      } catch (e) {}
      return {};
    }

    function saveTagMap() {
      try {
        localStorage.setItem(TAG_STORAGE_KEY, JSON.stringify(tagMap));
      } catch (e) {}
    }

    function setFilePillStateUploaded(pill, nameEl) {
      pill.classList.remove("error");
      pill.classList.add("ready");
      nameEl.textContent = "Uploaded";
    }

    function setFilePillStateError(pill, nameEl) {
      pill.classList.remove("ready");
      pill.classList.add("error");
      nameEl.textContent = "Error";
    }

    function updateBuildButtonState() {
      const ready = !!(followersJson && followingJson);
      buildBtn.disabled = !ready;
      fileStatusText.classList.remove("ok", "err");
      if (ready) {
        fileStatusText.textContent = "Nice. Both files are uploaded. You can build the registry now.";
        fileStatusText.classList.add("ok");
      } else {
        fileStatusText.textContent = "Choose both followers_1.json and following.json.";
      }
    }

    function readJsonFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const obj = JSON.parse(evt.target.result);
            resolve(obj);
          } catch (e) {
            reject(e);
          }
        };
        reader.onerror = () => reject(new Error("Failed to read file"));
        reader.readAsText(file);
      });
    }

    async function handleFiles(files) {
      if (!files || !files.length) return;

      uploadStatus.textContent = "";
      uploadStatus.className = "upload-status";

      let newFollowersFile = null;
      let newFollowingFile = null;

      for (const f of files) {
        const lower = f.name.toLowerCase();
        if (lower === "followers_1.json") newFollowersFile = f;
        if (lower === "following.json" || lower === "following_1.json") newFollowingFile = f;
      }

      if (newFollowersFile) {
        followersJson = null;
        pillFollowers.classList.remove("ready", "error");
        nameFollowers.textContent = "Reading‚Ä¶";

        uploadStatus.textContent = "Reading followers_1.json‚Ä¶";
        uploadStatus.classList.add("loading");

        try {
          const data = await readJsonFile(newFollowersFile);
          followersJson = data;
          setFilePillStateUploaded(pillFollowers, nameFollowers);
        } catch (e) {
          followersJson = null;
          setFilePillStateError(pillFollowers, nameFollowers);
          uploadStatus.textContent = "Could not read followers_1.json.";
          uploadStatus.classList.remove("loading");
          uploadStatus.classList.add("error");
        }
      }

      if (newFollowingFile) {
        followingJson = null;
        pillFollowing.classList.remove("ready", "error");
        nameFollowing.textContent = "Reading‚Ä¶";

        if (!newFollowersFile) {
          uploadStatus.textContent = "Reading following.json‚Ä¶";
          uploadStatus.classList.add("loading");
        }

        try {
          const data = await readJsonFile(newFollowingFile);
          followingJson = data;
          setFilePillStateUploaded(pillFollowing, nameFollowing);
        } catch (e) {
          followingJson = null;
          setFilePillStateError(pillFollowing, nameFollowing);
          uploadStatus.textContent = "Could not read following.json.";
          uploadStatus.classList.remove("loading");
          uploadStatus.classList.add("error");
        }
      }

      updateBuildButtonState();

      if (followersJson && followingJson) {
        uploadStatus.textContent = "Both files uploaded.";
        uploadStatus.classList.remove("loading");
        uploadStatus.classList.add("done");
      } else if (!uploadStatus.classList.contains("error")) {
        uploadStatus.textContent = "Waiting for the other file.";
      }
    }

    fileInput.addEventListener("change", (e) => {
      handleFiles(e.target.files);
    });

    function isProbablyDeleted(title, href) {
      if (!title || !href) return true;
      const lower = String(title).toLowerCase();
      if (lower === "instagram user") return true;
      if (lower.startsWith("__deleted__")) return true;
      if (!href.includes("instagram.com")) return true;
      return false;
    }

    function buildNotFollowingBack(followersData, followingData) {
      const followers = new Set();
      if (Array.isArray(followersData)) {
        for (const entry of followersData) {
          const data = entry && entry.string_list_data;
          if (Array.isArray(data) && data[0] && data[0].value) {
            const uname = String(data[0].value || "").trim().toLowerCase().replace(/^@/, "");
            if (!uname || uname.includes("deleted")) continue;
            followers.add(uname);
          }
        }
      }

      const followingEntries = [];
      const list = followingData && followingData.relationships_following;
      if (Array.isArray(list)) {
        for (const entry of list) {
          const title = entry.title;
          const sdata = entry.string_list_data;
          if (!title || !Array.isArray(sdata) || !sdata[0]) continue;
          const href = sdata[0].href;
          const ts = sdata[0].timestamp;

          if (isProbablyDeleted(title, href)) continue;

          const uname = String(title || "").trim().toLowerCase().replace(/^@/, "");
          if (!uname || uname.includes("deleted")) continue;

          followingEntries.push({ username: uname, display: title, href, timestamp: ts });
        }
      }

      return followingEntries
        .filter(e => !followers.has(e.username))
        .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
    }

    function applyRowTag(row, tag) {
      row.classList.remove(
        "tag-unfollowed",
        "tag-influencer",
        "tag-news",
        "tag-meme",
        "tag-other"
      );
      row.querySelectorAll(".tag-btn").forEach(btn => btn.classList.remove("active"));

      const username = (row.getAttribute("data-username-key") || "").toLowerCase();

      if (!tag) {
        if (username) {
          delete tagMap[username];
          saveTagMap();
        }
        return;
      }

      row.classList.add("tag-" + tag);
      const btn = row.querySelector(".tag-btn[data-tag='" + tag + "']");
      if (btn) btn.classList.add("active");

      if (username) {
        tagMap[username] = tag;
        saveTagMap();
      }
    }

    function renderTable(notFollowingList) {
      const tbody = document.querySelector("#fake-list-table tbody");
      tbody.innerHTML = "";

      tagMap = loadTagMap();

      for (const e of notFollowingList) {
        const usernameKey = e.username || "";
        const the_display = e.display || e.username;
        const displayName = the_display;
        const href = e.href || ("https://www.instagram.com/" + e.username);
        const ts = e.timestamp;
        let dateStr = "unknown";
        if (typeof ts === "number") {
          const d = new Date(ts * 1000);
          const opts = {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit"
          };
          dateStr = d.toLocaleString(undefined, opts);
        }
        const tr = document.createElement("tr");
        tr.setAttribute("data-username", displayName);
        tr.setAttribute("data-username-key", usernameKey.toLowerCase());
        tr.setAttribute("data-timestamp", ts || "");

        tr.innerHTML = `
          <td class="user-cell" title="Mark them however they deserve">
            <div class="user-main">
              <a href="${href}" target="_blank">${displayName}</a>
              <button class="user-copy-btn" data-href="${href}" title="Copy link">
                Copy
              </button>
            </div>
          </td>
          <td class="date-cell">${dateStr}</td>
          <td class="status-cell">
          </td>
        `;

        const tdStatus = tr.querySelector(".status-cell");

        const statusConfig = [
          { key: "unfollowed",  label: "Unfollowed ‚ùå" },
          { key: "influencer",  label: "Influencer / Celeb üé•" },
          { key: "news",        label: "News üì∞" },
          { key: "meme",        label: "Meme Page üòÇ" },
          { key: "other",       label: "Other üìÇ" }
        ];

        statusConfig.forEach(({ key, label }) => {
          const btn = document.createElement("button");
          btn.className = "tag-btn";
          btn.dataset.tag = key;
          btn.textContent = label;
          tdStatus.appendChild(btn);
        });

        const savedTag = tagMap[usernameKey.toLowerCase()];
        if (VALID_TAGS.includes(savedTag)) {
          applyRowTag(tr, savedTag);
        }

        tbody.appendChild(tr);
      }

      document.getElementById("count-total").textContent = notFollowingList.length;
      document.getElementById("count-all").textContent = notFollowingList.length;

      const jokeEl = document.getElementById("joke-line");
      if (jokeEl && jokes.length) {
        jokeEl.textContent = jokes[Math.floor(Math.random() * jokes.length)];
      }
    }

    function setupTagging() {
      const tableBody = document.querySelector("#fake-list-table tbody");
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");

      const counts = {
        all: 0,
        unfollowed: 0,
        influencer: 0,
        news: 0,
        meme: 0,
        other: 0,
        processed: 0
      };

      function recalcCounts(activeFilter = "all") {
        const rows = Array.from(document.querySelectorAll("#fake-list-table tbody tr"));
        counts.all = rows.length;
        counts.unfollowed = 0;
        counts.influencer = 0;
        counts.news = 0;
        counts.meme = 0;
        counts.other = 0;
        counts.processed = 0;

        let visible = 0;

        rows.forEach(row => {
          let tag = null;
          if (row.classList.contains("tag-unfollowed")) tag = "unfollowed";
          if (row.classList.contains("tag-influencer")) tag = "influencer";
          if (row.classList.contains("tag-news")) tag = "news";
          if (row.classList.contains("tag-meme")) tag = "meme";
          if (row.classList.contains("tag-other")) tag = "other";

          if (tag) {
            counts[tag] += 1;
            counts.processed += 1;
          }

          if (row.style.display !== "none") visible += 1;
        });

        document.getElementById("count-all").textContent = counts.all;
        document.getElementById("count-unfollowed").textContent = counts.unfollowed;
        document.getElementById("count-influencer").textContent = counts.influencer;
        document.getElementById("count-news").textContent = counts.news;
        document.getElementById("count-meme").textContent = counts.meme;
        document.getElementById("count-other").textContent = counts.other;

        const pct = counts.all ? Math.round((counts.processed / counts.all) * 100) : 0;
        progressBar.style.width = pct + "%";

        const filterLabel = activeFilter === "all"
          ? "All"
          : activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1);
        progressText.textContent =
          "Processed: " +
          counts.processed +
          " / " +
          counts.all +
          " (" +
          pct +
          "%) ‚Ä¢ Viewing " +
          visible +
          " (" +
          filterLabel +
          ")";

        // Status orb blurred aura based on tagged counts
        let u = counts.unfollowed;
        let i = counts.influencer;
        let n = counts.news;
        let m = counts.meme;
        let o = counts.other;

        let totalTagged = u + i + n + m + o;
        if (totalTagged === 0) totalTagged = 1;

        const pu = (u / totalTagged) * 360;
        const pi = (i / totalTagged) * 360;
        const pn = (n / totalTagged) * 360;
        const pm = (m / totalTagged) * 360;
        const po = (o / totalTagged) * 360;

        let a0 = 0;
        let a1 = a0 + pu;
        let a2 = a1 + pi;
        let a3 = a2 + pn;
        let a4 = a3 + pm;
        let a5 = 360;

        const pie = `
          conic-gradient(
            from 210deg,
            rgba(248, 113, 113, 0.85) 0deg ${a1}deg,
            rgba(96, 165, 250, 0.85) ${a1}deg ${a2}deg,
            rgba(250, 204, 21, 0.9)  ${a2}deg ${a3}deg,
            rgba(52, 211, 153, 0.9)  ${a3}deg ${a4}deg,
            rgba(168, 85, 247, 0.95) ${a4}deg ${a5}deg
          )
        `;

        orbEl.style.background = pie;
      }

      function copyToClipboard(text, btn) {
        if (!navigator.clipboard) {
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.opacity = "0";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          try { document.execCommand("copy"); } catch (e) {}
          document.body.removeChild(ta);
        } else {
          navigator.clipboard.writeText(text).catch(() => {});
        }
        btn.classList.add("copied");
        setTimeout(() => btn.classList.remove("copied"), 800);
      }

      tableBody.addEventListener("click", (evt) => {
        const tagBtn = evt.target.closest(".tag-btn");
        const rowCopyBtn = evt.target.closest(".user-copy-btn");

        if (rowCopyBtn) {
          const href = rowCopyBtn.getAttribute("data-href");
          if (href) copyToClipboard(href, rowCopyBtn);
          return;
        }

        if (!tagBtn) return;

        const row = tagBtn.closest("tr");
        const tag = tagBtn.getAttribute("data-tag");

        let currentTag = null;
        if (row.classList.contains("tag-unfollowed")) currentTag = "unfollowed";
        if (row.classList.contains("tag-influencer")) currentTag = "influencer";
        if (row.classList.contains("tag-news")) currentTag = "news";
        if (row.classList.contains("tag-meme")) currentTag = "meme";
        if (row.classList.contains("tag-other")) currentTag = "other";

        const newTag = (currentTag === tag) ? null : tag;
        applyRowTag(row, newTag);
        recalcCounts(window.currentActiveFilter || "all");
      });

      document.getElementById("reset-tags-btn").addEventListener("click", () => {
        const rows = document.querySelectorAll("#fake-list-table tbody tr");
        rows.forEach(row => applyRowTag(row, null));
        tagMap = {};
        saveTagMap();
        recalcCounts(window.currentActiveFilter || "all");
      });

      window.recalcCountsGlobal = recalcCounts;
      window.currentActiveFilter = "all";

      recalcCounts("all");
    }

    function setupFiltersAndSorting() {
      const searchInput = document.getElementById("search-input");
      const rowsSelector = "#fake-list-table tbody tr";
      let activeFilter = "all";
      let searchTerm = "";
      let currentSort = { key: "timestamp", dir: "desc" };

      function rowMatchesFilterAndSearch(row, filter, searchTerm) {
        const username = (row.getAttribute("data-username") || "").toLowerCase();

        let tag = null;
        if (row.classList.contains("tag-unfollowed")) tag = "unfollowed";
        if (row.classList.contains("tag-influencer")) tag = "influencer";
        if (row.classList.contains("tag-news")) tag = "news";
        if (row.classList.contains("tag-meme")) tag = "meme";
        if (row.classList.contains("tag-other")) tag = "other";

        const matchesFilter = (filter === "all") ? true : tag === filter;
        const matchesSearch = username.includes(searchTerm.toLowerCase());
        return matchesFilter && matchesSearch;
      }

      function applyFilterAndSearch() {
        const rows = document.querySelectorAll(rowsSelector);
        rows.forEach(row => {
          const show = rowMatchesFilterAndSearch(row, activeFilter, searchTerm);
          row.style.display = show ? "" : "none";
        });
        document.querySelectorAll(".filter-chip").forEach(chip => {
          chip.classList.toggle("active", chip.getAttribute("data-filter") === activeFilter);
        });

        if (typeof window.recalcCountsGlobal === "function") {
          window.currentActiveFilter = activeFilter;
          window.recalcCountsGlobal(activeFilter);
        }
      }

      document.querySelector(".filters").addEventListener("click", evt => {
        const chip = evt.target.closest(".filter-chip");
        if (!chip) return;
        activeFilter = chip.getAttribute("data-filter") || "all";
        applyFilterAndSearch();
      });

      searchInput.addEventListener("input", () => {
        searchTerm = searchInput.value || "";
        applyFilterAndSearch();
      });

      function sortTableBy(key, direction) {
        const tbody = document.querySelector("#fake-list-table tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        rows.sort((a, b) => {
          if (key === "username") {
            const ua = (a.getAttribute("data-username") || "").toLowerCase();
            const ub = (b.getAttribute("data-username") || "").toLowerCase();
            if (ua < ub) return direction === "asc" ? -1 : 1;
            if (ua > ub) return direction === "asc" ? 1 : -1;
            return 0;
          }
          if (key === "timestamp") {
            const ta = parseInt(a.getAttribute("data-timestamp") || "0", 10);
            const tb = parseInt(b.getAttribute("data-timestamp") || "0", 10);
            return direction === "asc" ? (ta - tb) : (tb - ta);
          }
          return 0;
        });

        rows.forEach(r => tbody.appendChild(r));
      }

      document.querySelectorAll("th.sortable").forEach(th => {
        th.addEventListener("click", () => {
          const key = th.getAttribute("data-sort-key");
          if (!key) return;

          if (currentSort.key === key) {
            currentSort.dir = currentSort.dir === "asc" ? "desc" : "asc";
          } else {
            currentSort.key = key;
            currentSort.dir = key === "timestamp" ? "desc" : "asc";
          }

          document.querySelectorAll("th.sortable").forEach(h => h.classList.remove("asc", "desc"));
          th.classList.add(currentSort.dir);

          sortTableBy(currentSort.key, currentSort.dir);
          applyFilterAndSearch();
        });
      });

      applyFilterAndSearch();
    }

    // Helper to detect small screens
    function isSmallScreen() {
      return window.matchMedia("(max-width: 700px)").matches;
    }

    // DVD-style orb physics using CSS variables, but disabled on small screens
    let orbX = 100;
    let orbY = 80;
    let orbVX = 70;  // px/sec
    let orbVY = 50;  // px/sec
    let lastTime = null;

    function stepOrb(timestamp) {
      // On small screens, keep orb off and don't animate
      if (isSmallScreen()) {
        orbEl.style.display = "none";
        lastTime = timestamp;
        requestAnimationFrame(stepOrb);
        return;
      } else {
        // On larger screens, ensure orb is visible
        orbEl.style.display = "";
      }

      if (!lastTime) lastTime = timestamp;
      const dt = (timestamp - lastTime) / 1000;
      lastTime = timestamp;

      const orbRect = orbEl.getBoundingClientRect();
      const orbW = orbRect.width || 780;
      const orbH = orbRect.height || 780;

      const maxX = window.innerWidth - orbW;
      const maxY = window.innerHeight - orbH;

      orbX += orbVX * dt;
      orbY += orbVY * dt;

      if (orbX <= 0) {
        orbX = 0;
        orbVX = Math.abs(orbVX);
      } else if (orbX >= maxX) {
        orbX = maxX;
        orbVX = -Math.abs(orbVX);
      }

      if (orbY <= 0) {
        orbY = 0;
        orbVY = Math.abs(orbVY);
      } else if (orbY >= maxY) {
        orbY = maxY;
        orbVY = -Math.abs(orbVY);
      }

      orbEl.style.setProperty("--orb-x", orbX + "px");
      orbEl.style.setProperty("--orb-y", orbY + "px");

      requestAnimationFrame(stepOrb);
    }

    requestAnimationFrame(stepOrb);

    window.addEventListener("resize", () => {
      lastTime = null;
    });

    buildBtn.addEventListener("click", () => {
      if (!(followersJson && followingJson)) return;
      uploadStatus.textContent = "Building registry‚Ä¶";
      uploadStatus.classList.remove("error");
      uploadStatus.classList.add("loading");

      const list = buildNotFollowingBack(followersJson, followingJson);
      renderTable(list);
      setupTagging();
      setupFiltersAndSorting();
      uploadStatus.textContent = "";
      uploadStatus.classList.remove("loading");

      landing.classList.add("hidden");
      mainApp.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  </script>
</body>
</html>
